<!DOCTYPE html>
<html lang="en-US">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <meta name="author" content="">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no">
    <meta http-equiv="Expires" content="-1">
    <meta http-equiv="Cache-Control" content="no-cache">
    <meta http-equiv="Pragma" content="no-cache">
    <meta name="description" content="">
    <meta name="Keywords" content="">
    <title>课堂评价</title>
    <link rel="stylesheet" href="css/reset.css" />
    <link rel="stylesheet" href="css/style.css" />
    <script src="js/mui.min.js"></script>
    <script type="text/javascript" src="js/zepto.min.js"></script>
    <script src="js/linq.min.js"></script>
    <script src="js/MobileCommon.js"></script>
    <script src="js/ejs.min.js"></script>
    
     
    <style>
        .h1_div {
            margin-top: 10px;
            background: white;
            text-align: center;
            height: 40px;
            margin: 20px -10px 0px -10px;
            border-top: 1px solid #cccccc;
            border-bottom: 1px solid #cccccc;
        }

            .h1_div h1 {
                margin-top: 10px;
                margin-left: 20px;
            }
    </style>
</head>
<body>
    <div id="main"></div>
    <div class="submitwrap">
        <input type="submit" id="btn_submit" class="button" value="提交" style="display:none;" />
    </div>

    <script src="../Scripts/WebCenter/TableDesigin.js"></script>
    <script src="../Scripts/WebCenter/Evaluate.js"></script>
    <!--答题-->
    <script type="text/template" id="item_table_view">
        <div class="header" style="position:fixed;">
            <a href="Index.html" class="back"><i class="iconfont">&#xe647;</i></a>
            <span class="title"><%=retData.Name%> 扫码评价</span>
        </div>

        <div class="test_time ">
            评价教师：<b style="color:white;"><%=retData.Info.CourseName%>-<%=retData.Info.TeacherName%></b>
            实时总分：<b id="sp_realtotal" style="color:white;">0</b>分
        </div>
        <div class="ti">
            <% $.each(retData.Table_Detail_Dic_List,function(hederindex,child){ %>
            <div class="h1_div">
                <h1 class="test_title" style="display: inline-block">
                    <b class="order_num"></b><b>111</b>
                </h1>
            </div>
            <% $.each(child.Eva_TableDetail_List,function(tindex,titem){ %>
          
                <div class="test_area indicatype">
                    <input type="hidden" value="<%=titem.Eva_table_Id%>" name="name_title" />
                    <input type="hidden" value="<%=titem.Id%>" name="name_id" />
                    <input type="hidden" value="<%=titem.QuesType_Id%>" name="name_QuesType_Id" />

                    <% if(titem.QuesType_Id!=3){ %>
                    <div id="div_ques_<%=titem.Id%>" class="test_detail">
                        <h1 class="test_type">
                            <b class="order_num"><%=(++tindex)%>.</b><b><%=titem.Name%></b>
                            <% if(retData.IsScore==0){ %><b>(<span><%=titem.OptionF_S_Max%></span>分)</b><%}%>
                        </h1>
                        <ul id="ul_ques_<%=titem.Id%>" class="radios maxques">
                            <% if(titem.OptionA!=""){ %>
                            <li lioption="OptionA">
                                <span>
                                    A<input type="radio" flv="OptionA" name="name_<%=titem.Id%>" value="<%=titem.OptionA_S%>}" />
                                </span>
                                <div><%=titem.OptionA%><b class="numbers isscore">(<%=titem.OptionA_S%>分)</b></div>
                            </li>
                            <% } %>
                            <% if(titem.OptionB!=""){ %>
                            <li lioption="OptionB">
                                <span>
                                    B<input type="radio" flv="OptionB" name="name_<%=titem.Id%>" value="<%=titem.OptionB_S%>" />
                                </span>                              
                                <div><%=titem.OptionB%><b class="numbers isscore">(<%=titem.OptionB_S%>分)</b></div>
                            </li>
                            <% } %>
                            <% if(titem.OptionC!=""){ %>
                            <li lioption="OptionC">
                                <span>
                                    C<input type="radio" flv="OptionC" name="name_<%=titem.Id%>" value="<%=titem.OptionC_S%>" />
                                </span>                              
                                <div><%=titem.OptionC%><b class="numbers isscore">(<%=titem.OptionC_S%>分)</b></div>
                            </li>
                            <% } %>
                            <% if(titem.OptionD!=""){ %>
                            <li lioption="OptionD">
                                <span>
                                    D<input type="radio" flv="OptionD" name="name_<%=titem.Id%>" value="<%=titem.OptionD_S%>" />
                                </span>                              
                                <div><%=titem.OptionD%><b class="numbers isscore">(<%=titem.OptionD_S%>分)</b></div>
                            </li>
                            <% } %>
                            <% if(titem.OptionE!=""){ %>
                            <li lioption="OptionE">
                                <span>
                                    E<input type="radio" flv="OptionE" name="name_<%=titem.Id%>" value="<%=titem.OptionE_S%>" />
                                </span>                                
                                <div><%=titem.OptionE%><b class="numbers isscore">(<%=titem.OptionE_S%>分)</b></div>
                            </li>
                            <% } %>
                            <% if(titem.OptionF!=""){ %>
                            <li lioption="OptionF">
                                <span>
                                    F<input type="radio" flv="OptionF" name="name_<%=titem.Id%>" value="<%=titem.OptionF_S%>" />
                                </span>                                
                                <div><%=titem.OptionF%><b class="numbers isscore">(<%=titem.OptionF_S%>分)</b></div>
                            </li>
                            <% } %>
                        </ul>
                    </div>
                    <% }else{ %>
                    <div id="div_ques_<%=titem.Id%>" class="test_detail">
                        <h1 class="test_type">
                            <b class="order_num"><%=(++tindex)%>.</b><b><%=titem.Name%></b>
                        </h1>
                        <textarea name="" id="" class="textarea" placeholder="请输入内容"></textarea>
                    </div>
                    <%} %>
                </div>         
            <% }) %>

            <% }) %>
        </div>
    </script>

    <!--试卷展示-->
    <script type="text/template" id="item_table_show">
        <div class="header" style="position:fixed;">
            <a href="Index.html" class="back"><i class="iconfont">&#xe647;</i></a>
            <span class="title"><%=retData.Name%> 调查与测验</span>
        </div>
        <div class="test_time">
            实时总分：<b id="sp_realtotal" style="color:white;">0</b>分
        </div>
        <div class="ti">
            <% $.each(retData.Table_Detail_Dic_List[0].Eva_TableDetail_List,function(tindex,titem){ %>
            <div class="test_area indicatype">
                <% if(titem.QuesType_Id!=3){ %>
                <div id="div_ques_<%=titem.Id%>" class="test_detail">
                    <h1 class="test_type">
                        <b class="order_num"><%=(++tindex)%>.</b><b><%=titem.Name%></b>
                        <% if(retData.IsScore==0){ %><b>(<span id="sp_<%=titem.Id%>"></span>分)</b><%}%>
                    </h1>
                    <% if(retData.IsScore==0){ %>
                    <ul id="ul_ques_<%=titem.Id%>" class="radios maxques">
                        <% if(titem.OptionA!=""){ %>
                        <li lioption="OptionA" class='<%=titem.Answer=="OptionA"?"on":""%>'>
                            <span>
                                A<input type="radio" name="name_<%=titem.Id%>" value="" />
                            </span>
                            <div><%=titem.OptionA%>(<b class="numbers"><%=titem.OptionA_S%></b>分)</div>
                        </li>
                        <% } %>
                        <% if(titem.OptionB!=""){ %>
                        <li lioption="OptionB" class='<%=titem.Answer=="OptionB"?"on":""%>'>
                            <span>
                                B<input type="radio" name="name_<%=titem.Id%>" value="" />
                            </span>
                            <div><%=titem.OptionB%>(<b class="numbers"><%=titem.OptionB_S%></b>分)</div>
                        </li>
                        <% } %>
                        <% if(titem.OptionC!=""){ %>
                        <li lioption="OptionC" class='<%=titem.Answer=="OptionC"?"on":""%>'>
                            <span>
                                C<input type="radio" name="name_<%=titem.Id%>" value="" />
                            </span>
                            <div><%=titem.OptionC%><b class="numbers">(<%=titem.OptionC_S%>分)</b></div>
                        </li>
                        <% } %>
                        <% if(titem.OptionD!=""){ %>
                        <li lioption="OptionD" class='<%=titem.Answer=="OptionD"?"on":""%>'>
                            <span>
                                D<input type="radio" name="name_<%=titem.Id%>" value="" />
                            </span>
                            <div><%=titem.OptionD%>(<b class="numbers"><%=titem.OptionD_S%></b>分)</div>
                        </li>
                        <% } %>
                        <% if(titem.OptionE!=""){ %>
                        <li lioption="OptionE" class='<%=titem.Answer=="OptionE"?"on":""%>'>
                            <span>
                                E<input type="radio" name="name_<%=titem.Id%>" value="" />
                            </span>
                            <div><%=titem.OptionE%>(<b class="numbers"><%=titem.OptionE_S%></b>分)</div>
                        </li>
                        <% } %>
                        <% if(titem.OptionF!=""){ %>
                        <li lioption="OptionF" class='<%=titem.Answer=="OptionF"?"on":""%>'>
                            <span>
                                F<input type="radio" name="name_<%=titem.Id%>" value="" />
                            </span>
                            <div><%=titem.OptionF%>(<b class="numbers"><%=titem.OptionF_S%></b>分)</div>
                        </li>
                        <% } %>
                    </ul>
                    <% }else{ %>
                    <ul id="ul_ques_<%=titem.Id%>" class="radios maxques">
                        <% if(titem.OptionA!=""){ %>
                        <li lioption="OptionA" class='<%=titem.Answer=="OptionA"?"on":""%>'>
                            <span>
                                A<input type="radio" name="name_<%=titem.Id%>" value="" />
                            </span>
                            <div><%=titem.OptionA%></div>
                        </li>
                        <% } %>
                        <% if(titem.OptionB!=""){ %>
                        <li lioption="OptionB" class='<%=titem.Answer=="OptionB"?"on":""%>'>
                            <span>
                                B<input type="radio" name="name_<%=titem.Id%>" value="" />
                            </span>
                            <div><%=titem.OptionB%></div>
                        </li>
                        <% } %>
                        <% if(titem.OptionC!=""){ %>
                        <li lioption="OptionC" class='<%=titem.Answer=="OptionC"?"on":""%>'>
                            <span>
                                C<input type="radio" name="name_<%=titem.Id%>" value="" />
                            </span>
                            <div><%=titem.OptionC%></div>
                        </li>
                        <% } %>
                        <% if(titem.OptionD!=""){ %>
                        <li lioption="OptionD" class='<%=titem.Answer=="OptionD"?"on":""%>'>
                            <span>
                                D<input type="radio" name="name_<%=titem.Id%>" value="" />
                            </span>
                            <div><%=titem.OptionD%></div>
                        </li>
                        <% } %>
                        <% if(titem.OptionE!=""){ %>
                        <li lioption="OptionE" class='<%=titem.Answer=="OptionE"?"on":""%>'>
                            <span>
                                E<input type="radio" name="name_<%=titem.Id%>" value="" />
                            </span>
                            <div><%=titem.OptionE%></div>
                        </li>
                        <% } %>
                        <% if(titem.OptionF!=""){ %>
                        <li lioption="OptionF" class='<%=titem.Answer=="OptionF"?"on":""%>'>
                            <span>
                                F<input type="radio" name="name_<%=titem.Id%>" value="" />
                            </span>
                            <div><%=titem.OptionF%></div>
                        </li>
                        <% } %>
                    </ul>
                    <%} %>
                </div>
                <% }else{ %>
                <div id="div_ques_<%=titem.Id%>" class="test_detail">
                    <h1 class="test_type">
                        <b class="order_num"><%=(++tindex)%>.</b><b><%=titem.Name%></b>
                    </h1>
                    <textarea class="textarea"><%=titem.Answer%></textarea>
                </div>
                <%} %>
            </div>
            <% }) %>
        </div>
    </script>

    <script type="text/javascript">
        mui.init({
            swipeBack: true,//启用右滑关闭功能
            keyEventBind: {
                backbutton: true  //启动back按键监听
            },
            statusBarBackground: '#6a264b',
        });
        var UrlDate = new GetUrlDate();
        var task_Id = UrlDate.id;
        var table_Id = UrlDate.id;
        var isAnswer = 0; //是否答题 0未答题；1已答题
        var total = 0;//试卷总分数


        var SectionID =

        $(function () {
            if (isAnswer == 1) { //已答题
                Get_Eva_TaskAnswer_ById();
            } else {
                if (isAnswer == 0) { //从手机端首页进入
                    initdata();
                } else {
                    GetIsAnswer_Eva_ById(); //扫码后，判断是否答题
                }
            }
            $('#btn_submit').on('tap', function () {
                SaveEvlData();
            });
        });
        //判断是否已经答过题
        function GetIsAnswer_Eva_ById() {
            $.ajax({
                url: HanderServiceUrl + "/Eva_Manage/Eva_ManageHandler.ashx",
                type: "post",
                async: false,
                dataType: "json",
                data: { Func: "GetIsAnswer_Eva_ById", "Id": task_Id, StudentUID: login_User.UniqueNo },
                success: function (json) {
                    if (json.result.errNum == 0) { //未答题
                        initdata();
                    } else if (json.result.errNum == 1) { //已经答过
                        Get_Eva_TaskAnswer_ById();
                    } else {
                        window.location.href = "NoCode.html?te=" + json.result.errNum;
                    }
                },
                error: function () { } //接口错误时需要执行的
            });
        }
        //初始化表格列表
        function initdata() {
            $("#btn_submit").show();
            $("#main").empty();

            RoomID = getQueryString('rId');
            ReguID = getQueryString('ReguID');

            UI_Table_View.PageType = 'onlinetest';
            UI_Table_View.IsPage_Display = true;
            UI_Table_View.Get_Eva_TableDetail_Compleate = function (retData) {
                $("#main").append(ejs.render($('#item_table_view').html(), { retData: retData }));
                GetTask_Score(0, retData.IsScore);
                InitControl(retData.IsScore);

                var info = retData.Info;

                SectionID = info.SectionID;
                DisplayName = info.DisplayName;
                ReguID = info.ReguID;
                ReguName = info.ReguName;
                CourseID = info.CourseID;
                CourseName = info.CourseName;
                TeacherUID = info.TeacherUID;
                TeacherName = info.TeacherName;

                AnswerUID = login_User.UniqueNo;
                AnswerName = login_User.Name;
                TableName = retData.Name;

                Type = 3;
                Eva_Role = 2;
                HeaderList = [];

                UI_Table_View.scoreInit(retData);
            };
            UI_Table_View.Get_Eva_TableDetail();
        }
        function SaveEvlData() {

            Is_AddQuesType = true;
            SubmitQuestion();

            //var realscore = $("#sp_realtotal").html();
            //var obj = new Object();





            //obj.func = "AddEva_TaskAnswer";
            //obj.Task_Id = task_Id;
            //obj.CreateUID = login_User.UniqueNo;

            //obj.State = 3;
            //obj.Score = total;
            //var array = [];
            //var flg = 0;
            //$(".test_detail").each(function () {
            //    var li_ques = $(this).find("li.on");
            //    if ($(this).find("li").length != 0 && li_ques.length == 0) {
            //        flg++;
            //        MesTips('请答题完整！');
            //        return false;
            //    }
            //    var area_q = $(this).find("textarea");
            //    if (area_q.length != 0 && area_q.val().trim() == "") {
            //        flg++;
            //        MesTips('请答题完整！');
            //        return false;
            //    }
            //    var sub_array = new Object();
            //    var TableDetailID = $(this).attr("id").replace("div_ques_", "");
            //    var sub_Score = $(this).find("li.on").find('b.numbers').html() || "";
            //    var Answer = "";
            //    if (area_q.length != 0) Answer = area_q.val().trim();
            //    if (li_ques.length != 0) Answer = li_ques.attr("lioption");
            //    sub_array.TableDetailID = TableDetailID;
            //    sub_array.Score = sub_Score;
            //    sub_array.Answer = Answer;
            //    array.push(sub_array);
            //});
            //obj.List = JSON.stringify(array);
            //if (flg == 0) {
            //    $.ajax({
            //        url: HanderServiceUrl + "/Eva_Manage/Eva_ManageHandler.ashx",
            //        type: "post",
            //        async: false,
            //        dataType: "json",
            //        data: obj,
            //        success: function (json) {
            //            if (json.result.errMsg == "success") {
            //                MesTips('提交成功');
            //                window.location.href = "Index.html";
            //                //$("#btn_submit").parent().hide();
            //                //$('.ti').css('paddingBottom', '10px');
            //                //$('.radios li').off('tap');
            //                //InitControl_Answer();
            //            }
            //        },
            //        error: function () {
            //            //接口错误时需要执行的
            //        }
            //    });
            //}
            debugger;
        }

        //学生查看试卷
        function Get_Eva_TaskAnswer_ById() {
            $("#btn_submit").parent().hide();
            $("#main").empty();
            var params = { Func: "Get_Eva_TaskAnswer_ById_Mobile", "Id": task_Id, StudentUID: login_User.UniqueNo };
            $.ajax({
                url: HanderServiceUrl + "/Eva_Manage/Eva_ManageHandler.ashx",
                type: "post",
                async: false,
                dataType: "json",
                data: params,
                success: function (json) {
                    if (json.result.errNum == 0) {
                        var retData = json.result.retData;
                        $("#main").append(ejs.render($('#item_table_show').html(), { retData: retData }));
                        $('.ti').css('paddingBottom', '10px');
                        GetTask_Score(1, retData.Eva_Task.IsScore);
                        InitControl_Answer();
                    }
                },
                error: function () {
                    //接口错误时需要执行的
                }
            });
        }
        function GetTask_Score(type, isscore) { //答题-设置分数
            type = arguments[0] || 0;
            if (isscore == 0) {

                if (type != 0) {
                    var realTotal = 0;//实时总分
                    $(".radios li").each(function () {
                        if ($(this).hasClass('on')) {
                            realTotal = numAdd(realTotal, $(this).find('b.numbers').html());
                        }
                    });
                    $("#sp_realtotal").html(realTotal);
                }
            }
            else {
                $("#sp_realtotal").html("不计");
            }
        }
    </script>
</body>
</html>